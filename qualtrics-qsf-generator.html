<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M2C2 Qualtrics QSF Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 50px;
        }

        label,
        input {
            display: block;
            margin-bottom: 10px;
        }

        .auto-next-container,
        .language-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .language-container label {
            margin-right: 10px;
            line-height: 30px;
            margin-bottom: 0;
        }

        .language-container select {
            height: 30px;
        }

        .task-list {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }

        .task-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            cursor: move;
            width: 600px;
        }

        .task-list li input {
            width: 100px;
            margin-left: 20px;
            margin-top: 10px;
        }

        .task-list li textarea {
            width: 300px;
            margin-left: 20px;
            margin-top: 10px;
        }

        .task-list li span {
            width: 150px;
        }

        .sortable-ghost {
            opacity: 0.4;
        }

        .instructions {
            width: 600px;
        }

        .instructions li {
            margin-bottom: 10px;
        }

        .swal2-html-container {
            text-align: left !important;
        }


    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <h1>M2C2 Qualtrics QSF Generator</h1>
    <div class="instructions">
        <h3>About This QSF Qualtrics Generator</h3>
        <p>This tool is designed to create a QSF file for our M2C2 cognitive activities, allowing for integration into Qualtrics. Once generated, the QSF file will need to be imported into Qualtrics, after which you can add survey questions as desired. Please note that JavaScript must be enabled for this tool, which is not available in the free version of Qualtrics.</p>

        <h4>How to Import the QSF File into Qualtrics</h4>
        <p>Follow these steps to import the QSF file:</p>
        <ol>
            <li>Go to <strong>Qualtrics</strong> and select <strong>Create a new project</strong>.</li>
            <li>Choose <strong>Survey</strong> and click <strong>Get Started</strong>.</li>
            <li>In the <strong>Name Project</strong> field, enter your project name.</li>
            <li>Use the dropdown menu to select <strong>Import a QSF file</strong>.</li>
            <li>Choose the QSF file you downloaded from this QSF generator.</li>
            <li>Select <strong>Create Project</strong>.</li>
        </ol>

        <h3>Instructions:</h3>
        <ul>
            <li>Tasks are presented to the user in the order displayed below. If you would like, you can click and drag the tasks to change the order.</li>
            <li>Specify the number of trials for each task. If you do not want a specific task, please enter '0' trials. Tasks with no trials will be moved to the end of the list automatically when generating the QSF file.</li>
            <li>All cognitive tasks will run back-to-back. Auto next/submit will 'click' the next/submit button on that Qualtrics page. This is recommended.</li>
	        <li>The number of trials and language will be added to the parameters for each task. Additional parameters can be added if desired. The majority of the time, the defaults will suffice. Only change parameters if you understand why you are changing the parameter. Additional parameters should only be entered as one line of 'key:value' pairs separated by a comma. You can find the schemas listed here for each cognitive activity: <a href="https://m2c2-project.github.io/m2c2kit/docs/schemas/what-is-schema" target="_blank">visit m2c2kit webpage</a> Here is an example of a parameter and the format: show_quit_button=false::boolean.
</li>
        </ul>
        <hr>

        <p>The suggested default parameters are designed for brief assessments on mobile devices. Each takes approximately one minute to administer and is intended to be repeated multiple times a day over several days.</p>

        <hr>

        <h3>Current Cognitive Activities</h3>

        <p><b><u>Symbol Search</u></b><br>
        number_of_trials: 20</p>

        <p><b><u>Grid Memory</u></b><br>
        number_of_trials: 4</p>

        <p><b><u>Color Dots</u></b><br>
        number_of_trials: 5</p>

        <p><b><u>Color Shapes</u></b><br>
        number_of_trials: 12<br>
        number_of_different_colors_trials: 6<br>
        shapes_presented_duration_ms: 500</p>

        <ul>
    <li>
        <p>The suggested default number of trials is 12. The number of trials <b>MUST</b> be an <b>EVEN number</b>.<br><br>
        <b>IMPORTANT:</b> The <b>number_of_different_colors_trials</b> should be ½ the total number of trials (e.g., if <b>number_of_trials = 20</b>, then the <b>number_of_different_colors_trials = 10</b>). Please make sure to also update this parameter.</p>
    </li>
    <li>
        <p>The <b>number_of_different_colors_trials</b> parameter is the number of trials where the shapes will change colors from the study phase to the test phase, where the correct answer chosen would be “Different.” The suggested default is 6 for this parameter to coincide with ½ of the number of default trials, which is 12.<br><br>
        <b>IMPORTANT:</b> The <b>number_of_different_colors_trials</b> should be ½ the total number of trials (e.g., if <b>number_of_trials = 20</b>, then the <b>number_of_different_colors_trials = 10</b>).</p>
    </li>
    <li>
        <p>The <b>shapes_presented_duration_ms</b> parameter is how long the shapes are shown in milliseconds. The default is 500 ms, but for older adults with suspected impairments or elevated dementia risk, it is suggested to make this 2000 ms.</p>
    </li>
</ul>
        <hr>
    </div>
    
    <form id="taskForm">
        <ul id="sortableTasks" class="task-list">
            <li data-task="SYMBOL_SEARCH">
                <span>Symbol Search</span>
                <input type="number" id="SYMBOL_SEARCH" name="symbolSearch" required min="0" placeholder="# Trials"
                    value="20">
                <textarea id="SYMBOL_SEARCH_PARAMS" name="SYMBOL_SEARCH_PARAMS" rows="4" cols="50"
                    placeholder="Additional Parameters"></textarea>
            </li>
            <li data-task="GRID_MEMORY">
                <span>Grid Memory</span>
                <input type="number" id="GRID_MEMORY" name="gridMemory" required min="0" placeholder="# Trials"
                    value="4">
                <textarea id="GRID_MEMORY_PARAMS" name="GRID_MEMORY_PARAMS" rows="4" cols="50"
                    placeholder="Additional Parameters"></textarea>
            </li>
            <li data-task="COLOR_DOTS">
                <span>Color Dots</span>
                <input type="number" id="COLOR_DOTS" name="colorDots" required min="0" placeholder="# Trials"
                    value="5">
                <textarea id="COLOR_DOTS_PARAMS" name="COLOR_DOTS_PARAMS" rows="4" cols="50"
                    placeholder="Additional Parameters"></textarea>
            </li>
            <li data-task="COLOR_SHAPES">
                <span>Color Shapes</span>
                <input type="number" id="COLOR_SHAPES" name="COLOR_SHAPES" required min="0" placeholder="# Trials"
                    value="12">
                <textarea id="COLOR_SHAPES_PARAMS" name="COLOR_SHAPES_PARAMS" rows="4" cols="50"
                    placeholder="Additional Parameters">number_of_different_colors_trials=6,shapes_presented_duration_ms=500</textarea>
            </li>
        </ul>
        <br>
        <div class="auto-next-container">
            <label for="autoNext">Auto Next/Submit</label>
            &nbsp;
            <input type="checkbox" id="autoNext" name="autoNext" value="TRUE">
        </div>
        <div class="language-container">
            <label for="m2c2Language">Language</label>
            &nbsp;
            <select id="m2c2Language" name="m2c2Language">
                <option value="en-US">English (en-US)</option>
                <option value="es-MX">Spanish (es-MX)</option>
                <option value="fr-FR">French (fr-FR)</option>
                <option value="de-DE">German (de-DE)</option>
                <option value="jp-JP">Japanese (jp-JP)</option>
            </select>
        </div>
        <br>
        <br>

        <button type="submit">Generate Qualtrics QSF File</button>
        <br><br>
    </form>

    <a id="downloadLink" style="display:none">Download the Qualtrics QSF File</a>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize Sortable.js for dragging tasks
            const sortable = new Sortable(document.getElementById('sortableTasks'), {
                animation: 150,
                ghostClass: 'sortable-ghost'
            });
        });

        function validateForm() {
            // Get all task elements
            const taskElements = document.querySelectorAll('#sortableTasks li');
            const taskList = Array.from(taskElements); // Convert NodeList to Array

            // Extract the trials and tasks
            const taskOrder = taskList.map(el => el.dataset.task); // Task identifiers
            const taskNumTrials = taskList.map(el => parseInt(el.querySelector('input').value, 10)); // Trial numbers
            const taskNumTrialsZero = taskNumTrials.filter(trial => trial === 0); // Trials with zero

            // Reorder tasks: move tasks with zero trials to the end
            const reorderedTasks = taskList.sort((a, b) => {
                const aTrials = parseInt(a.querySelector('input').value, 10);
                const bTrials = parseInt(b.querySelector('input').value, 10);

                // Tasks with zero trials go to the end
                return aTrials === 0 ? 1 : bTrials === 0 ? -1 : 0;
            });

            // Check if the order has changed
            const reorderedOrder = reorderedTasks.map(el => el.dataset.task); // New order of tasks
            const originalOrder = taskOrder; // Original order of tasks

            // If order has changed, update the DOM and notify the user
            if (JSON.stringify(reorderedOrder) !== JSON.stringify(originalOrder)) {
                // Update the DOM with reordered tasks
                const sortableTasksContainer = document.querySelector('#sortableTasks');
                sortableTasksContainer.innerHTML = ''; // Clear the current list
                reorderedTasks.forEach(task => sortableTasksContainer.appendChild(task)); // Append reordered tasks

                const zeroTrialTasks = reorderedTasks.filter(task => parseInt(task.querySelector('input').value, 10) === 0);

                // Extract task names for the notification
                const movedTaskNames = zeroTrialTasks.map(task => {
                    const taskName = task.querySelector('span').textContent;
                    return taskName || 'Unnamed Task';
                });

                // Alert the user that tasks with zero trials have been moved
                Swal.fire({
                    icon: 'info',
                    title: 'Tasks Reordered',
                    html: `One or more tasks with 0 trials were moved to the bottom:<br><ul>${movedTaskNames.map(task => `<li>${task}</li>`).join('')}</ul>`,
                    confirmButtonText: 'OK'
                });
            }

            var addParamsValid = true;

            // make sure additional params is in the correct format (csv, key=value or key=value::type)
            const additionalParams = document.querySelectorAll('textarea');
            for (var i = 0; i < additionalParams.length; i++) {
                var params = additionalParams[i].value;
                if (params.length > 0) {
                    var paramArray = params.split(',');
                    for (var j = 0; j < paramArray.length; j++) {
                        var param = paramArray[j];
                        if (param.includes('::')) {
                            var paramSplit = param.split('::');
                            if (paramSplit.length != 2) {
                                addParamsValid = false;
                            }
                        } else if (param.includes('=')) {
                            var paramSplit = param.split('=');
                            if (paramSplit.length != 2) {
                                addParamsValid = false;
                            }
                        } else {
                            addParamsValid = false;
                        }
                    }
                }
            }

            if (!addParamsValid) {
                // show swal error
                Swal.fire({
                    icon: 'info',
                    title: 'Additional Parameters',
                    html: `Please ensure that additional parameters are formatted correctly.<br><br>Parameters should be comma-separated and follow the format: <span style='font-weight:bold;font-style: italic;'>key=value</span> or <span style='font-weight:bold;font-style: italic;'>key=value::type</span>.`,
                    confirmButtonText: 'OK'
                });
                return false;
            }

            return true;
        }

        document.getElementById('taskForm').addEventListener('submit', function (event) {
            event.preventDefault(); // Prevent form submission

            var downloadLink = document.getElementById('downloadLink');

            // remove link from downloadLink and hide it
            downloadLink.href = '';
            downloadLink.download = '';
            downloadLink.textContent = '';
            downloadLink.style.display = 'none';

            // Validate form
            if (!validateForm()) {
                return;
            }

            var autoComplete = "FALSE";
            if (document.getElementById('autoNext').checked) {
                autoComplete = "TRUE";
            }

            // Get the task order from the sorted list
            const taskOrderElements = document.querySelectorAll('#sortableTasks li');
            const taskOrder = Array.from(taskOrderElements).map(el => el.dataset.task);
            const taskOrderString = taskOrder.join(',').toUpperCase();

            const language = document.getElementById('m2c2Language').value;

            // build an object like an array with the task and the number of trials
            var sessionActivities = [];
            for (var i = 0; i < taskOrder.length; i++) {
                var task = taskOrder[i];
                var taskTrials = document.getElementById(task).value;
                var taskParams = document.getElementById(task + "_PARAMS").value;
                sessionActivities.push({
                    "task": task,
                    "trials": taskTrials,
                    "params": taskParams
                });
            }

            // Generate the QSF
            const qsf = generateQSF(language, autoComplete, sessionActivities);

            // Create a download link
            downloadLink.href = URL.createObjectURL(qsf);
            downloadLink.download = 'm2c2_qualtrics.qsf';
            downloadLink.textContent = 'Click here to download your Qualtrics QSF File';
            downloadLink.style.display = 'block';
        });

        function generateQSF(language, autoComplete, sessionActivities) {
            const qsf =
            {
                "SurveyEntry": {
                    "SurveyID": "SV_1ImFvhvugBeA0dM",
                    "SurveyName": "M2C2",
                    "SurveyDescription": null,
                    "SurveyOwnerID": "UR_0ciZllifcla7X4F",
                    "SurveyBrandID": "pennstate",
                    "DivisionID": "DV_7VdU3bhgUIW23EE",
                    "SurveyLanguage": "EN",
                    "SurveyActiveResponseSet": "RS_85MeUsdOVIMZX70",
                    "SurveyStatus": "Active",
                    "SurveyStartDate": "0000-00-00 00:00:00",
                    "SurveyExpirationDate": "0000-00-00 00:00:00",
                    "SurveyCreationDate": "2024-11-22 08:24:04",
                    "CreatorID": "UR_0ciZllifcla7X4F",
                    "LastModified": "2024-11-25 11:50:46",
                    "LastAccessed": "0000-00-00 00:00:00",
                    "LastActivated": "2024-11-22 11:13:18",
                    "Deleted": null
                },
                "SurveyElements": [
                    {
                        "SurveyID": "SV_1ImFvhvugBeA0dM",
                        "Element": "BL",
                        "PrimaryAttribute": "Survey Blocks",
                        "SecondaryAttribute": null,
                        "TertiaryAttribute": null,
                        "Payload": [
                            {
                                "Type": "Default",
                                "Description": "Default Question Block",
                                "ID": "BL_em8om5Uhvv5QbFY",
                                "BlockElements": [
                                    {
                                        "Type": "Question",
                                        "QuestionID": "QID1"
                                    }
                                ]
                            },
                            {
                                "Type": "Trash",
                                "Description": "Trash \/ Unused Questions",
                                "ID": "BL_b4mg9Vd4VRKu778"
                            }
                        ]
                    },
                    {
                        "SurveyID": "SV_1ImFvhvugBeA0dM",
                        "Element": "FL",
                        "PrimaryAttribute": "Survey Flow",
                        "SecondaryAttribute": null,
                        "TertiaryAttribute": null,
                        "Payload": {
                            "Type": "Root",
                            "FlowID": "FL_1",
                            "Flow": [
                                {
                                    "Type": "EmbeddedData",
                                    "FlowID": "FL_4",
                                    "EmbeddedData": [
                                        {
                                            "Description": "M2C2_ASSESSMENT_00_NUM_TRIALS",
                                            "Type": "Custom",
                                            "Field": "M2C2_ASSESSMENT_00_NUM_TRIALS",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": "20"
                                        },
                                        {
                                            "Description": "M2C2_ASSESSMENT_01_NUM_TRIALS",
                                            "Type": "Custom",
                                            "Field": "M2C2_ASSESSMENT_01_NUM_TRIALS",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": "4"
                                        },
                                        {
                                            "Description": "M2C2_ASSESSMENT_02_NUM_TRIALS",
                                            "Type": "Custom",
                                            "Field": "M2C2_ASSESSMENT_02_NUM_TRIALS",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": "5"
                                        },
                                        {
                                            "Description": "M2C2_ASSESSMENT_03_NUM_TRIALS",
                                            "Type": "Custom",
                                            "Field": "M2C2_ASSESSMENT_03_NUM_TRIALS",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": "12"
                                        },
                                        {
                                            "Description": "M2C2_LANGUAGE",
                                            "Type": "Custom",
                                            "Field": "M2C2_LANGUAGE",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": "en-US"
                                        },
                                        {
                                            "Description": "M2C2_ASSESSMENT_ORDER",
                                            "Type": "Custom",
                                            "Field": "M2C2_ASSESSMENT_ORDER",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": "SYMBOL_SEARCH,GRID_MEMORY,COLOR_DOTS,COLOR_SHAPES"
                                        },
                                        {
                                            "Description": "M2C2_AUTO_ADVANCE",
                                            "Type": "Custom",
                                            "Field": "M2C2_AUTO_ADVANCE",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": "TRUE"
                                        },
                                        {
                                            "Description": "M2C2_ASSESSMENT_00_ADD_PARAMS",
                                            "Type": "Custom",
                                            "Field": "M2C2_ASSESSMENT_00_ADD_PARAMS",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": ""
                                        },
                                        {
                                            "Description": "M2C2_ASSESSMENT_01_ADD_PARAMS",
                                            "Type": "Custom",
                                            "Field": "M2C2_ASSESSMENT_01_ADD_PARAMS",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": ""
                                        },
                                        {
                                            "Description": "M2C2_ASSESSMENT_02_ADD_PARAMS",
                                            "Type": "Custom",
                                            "Field": "M2C2_ASSESSMENT_02_ADD_PARAMS",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": ""
                                        },
                                        {
                                            "Description": "M2C2_ASSESSMENT_03_ADD_PARAMS",
                                            "Type": "Custom",
                                            "Field": "M2C2_ASSESSMENT_03_ADD_PARAMS",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": "number_of_different_colors_trials=6,shapes_presented_duration_ms=500"
                                        },
                                        {
                                            "Description": "M2C2_DEBUG",
                                            "Type": "Custom",
                                            "Field": "M2C2_DEBUG",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false,
                                            "Value": "TRUE"
                                        }
                                    ]
                                },
                                {
                                    "Type": "Block",
                                    "ID": "BL_em8om5Uhvv5QbFY",
                                    "FlowID": "FL_2",
                                    "Autofill": []
                                },
                                {
                                    "Type": "EmbeddedData",
                                    "FlowID": "FL_5",
                                    "EmbeddedData": [
                                        {
                                            "Description": "M2C2_ASSESSMENT_00_TRIAL_DATA_00",
                                            "Type": "Recipient",
                                            "Field": "M2C2_ASSESSMENT_00_TRIAL_DATA_00",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false
                                        }
                                    ]
                                },
                                {
                                    "Type": "EmbeddedData",
                                    "FlowID": "FL_6",
                                    "EmbeddedData": [
                                        {
                                            "Description": "M2C2_ASSESSMENT_01_TRIAL_DATA_00",
                                            "Type": "Recipient",
                                            "Field": "M2C2_ASSESSMENT_01_TRIAL_DATA_00",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false
                                        }
                                    ]
                                },
                                {
                                    "Type": "EmbeddedData",
                                    "FlowID": "FL_7",
                                    "EmbeddedData": [
                                        {
                                            "Description": "M2C2_ASSESSMENT_02_TRIAL_DATA_00",
                                            "Type": "Recipient",
                                            "Field": "M2C2_ASSESSMENT_02_TRIAL_DATA_00",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false
                                        }
                                    ]
                                },
                                {
                                    "Type": "EmbeddedData",
                                    "FlowID": "FL_8",
                                    "EmbeddedData": [
                                        {
                                            "Description": "M2C2_ASSESSMENT_03_TRIAL_DATA_00",
                                            "Type": "Recipient",
                                            "Field": "M2C2_ASSESSMENT_03_TRIAL_DATA_00",
                                            "VariableType": "String",
                                            "DataVisibility": [],
                                            "AnalyzeText": false
                                        }
                                    ]
                                }
                            ],
                            "Properties": {
                                "Count": 7
                            }
                        }
                    },
                    {
                        "SurveyID": "SV_1ImFvhvugBeA0dM",
                        "Element": "PL",
                        "PrimaryAttribute": "Preview Link",
                        "SecondaryAttribute": null,
                        "TertiaryAttribute": null,
                        "Payload": {
                            "PreviewType": "Brand",
                            "PreviewID": "864b3b0d-c643-475a-bead-2030a1747fed"
                        }
                    },
                    {
                        "SurveyID": "SV_1ImFvhvugBeA0dM",
                        "Element": "SO",
                        "PrimaryAttribute": "Survey Options",
                        "SecondaryAttribute": null,
                        "TertiaryAttribute": null,
                        "Payload": {
                            "BackButton": "false",
                            "SaveAndContinue": "true",
                            "SurveyProtection": "PublicSurvey",
                            "BallotBoxStuffingPrevention": "false",
                            "NoIndex": "Yes",
                            "SecureResponseFiles": "true",
                            "SurveyExpiration": "None",
                            "SurveyTermination": "DefaultMessage",
                            "Header": "",
                            "Footer": "",
                            "ProgressBarDisplay": "None",
                            "PartialData": "+1 week",
                            "ValidationMessage": "",
                            "PreviousButton": "",
                            "NextButton": " \u2192 ",
                            "SurveyTitle": "Qualtrics Survey | Qualtrics Experience Management",
                            "SkinLibrary": "pennstate",
                            "SkinType": "templated",
                            "Skin": {
                                "brandingId": "246530610",
                                "templateId": "*base",
                                "overrides": null
                            },
                            "NewScoring": 1,
                            "SurveyMetaDescription": "The most powerful, simple and trusted way to gather experience data. Start your journey to experience management and try a free account today.",
                            "CustomStyles": [],
                            "headerMid": "",
                            "ProtectSelectionIds": true,
                            "SurveyName": "M2C2"
                        }
                    },
                    {
                        "SurveyID": "SV_1ImFvhvugBeA0dM",
                        "Element": "SCO",
                        "PrimaryAttribute": "Scoring",
                        "SecondaryAttribute": null,
                        "TertiaryAttribute": null,
                        "Payload": {
                            "ScoringCategories": [],
                            "ScoringCategoryGroups": [],
                            "ScoringSummaryCategory": null,
                            "ScoringSummaryAfterQuestions": 0,
                            "ScoringSummaryAfterSurvey": 0,
                            "DefaultScoringCategory": null,
                            "AutoScoringCategory": null
                        }
                    },
                    {
                        "SurveyID": "SV_1ImFvhvugBeA0dM",
                        "Element": "PROJ",
                        "PrimaryAttribute": "CORE",
                        "SecondaryAttribute": null,
                        "TertiaryAttribute": "1.1.0",
                        "Payload": {
                            "ProjectCategory": "CORE",
                            "SchemaVersion": "1.1.0"
                        }
                    },
                    {
                        "SurveyID": "SV_1ImFvhvugBeA0dM",
                        "Element": "STAT",
                        "PrimaryAttribute": "Survey Statistics",
                        "SecondaryAttribute": null,
                        "TertiaryAttribute": null,
                        "Payload": {
                            "MobileCompatible": true,
                            "ID": "Survey Statistics"
                        }
                    },
                    {
                        "SurveyID": "SV_1ImFvhvugBeA0dM",
                        "Element": "QC",
                        "PrimaryAttribute": "Survey Question Count",
                        "SecondaryAttribute": "1",
                        "TertiaryAttribute": null,
                        "Payload": null
                    },
                    {
                        "SurveyID": "SV_1ImFvhvugBeA0dM",
                        "Element": "RS",
                        "PrimaryAttribute": "RS_85MeUsdOVIMZX70",
                        "SecondaryAttribute": "Default Response Set",
                        "TertiaryAttribute": null,
                        "Payload": null
                    },
                    {
                        "SurveyID": "SV_1ImFvhvugBeA0dM",
                        "Element": "SQ",
                        "PrimaryAttribute": "QID1",
                        "SecondaryAttribute": "This placeholder will load M2C2. It will be hidden from the participant. Do not delete. Do not mo...",
                        "TertiaryAttribute": null,
                        "Payload": {
                            "QuestionText": "This placeholder will load M2C2. It will be hidden from the participant. Do not delete. Do not modify Survey Flow.",
                            "DefaultChoices": false,
                            "DataExportTag": "Q1",
                            "QuestionID": "QID1",
                            "QuestionType": "DB",
                            "Selector": "TB",
                            "DataVisibility": {
                                "Private": false,
                                "Hidden": false
                            },
                            "Configuration": {
                                "QuestionDescriptionOption": "UseText"
                            },
                            "QuestionDescription": "This placeholder will load M2C2. It will be hidden from the participant. Do not delete. Do not mo...",
                            "ChoiceOrder": [],
                            "Validation": {
                                "Settings": {
                                    "Type": "None"
                                }
                            },
                            "GradingData": [],
                            "Language": [],
                            "NextChoiceId": 4,
                            "NextAnswerId": 1,
                            "QuestionJS": "Qualtrics.SurveyEngine.addOnload(function () {\n    jQuery(\"#\" + this.questionId).hide();\n\n    console.log(\"Starting M2C2Kit routine...\");\n\n    \/\/ Add a container for the M2C2Kit\n    jQuery(\"body\").append('<div id=\"m2c2kit-container\" style=\"position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background-color: white;\"><\/div>');\n    jQuery(\"#m2c2kit-container\").append('<div id=\"m2c2kit\" style=\"position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;\"><\/div>');\n\n    \/\/ Load the module shims\n    var esModuleShims = document.createElement('script');\n    esModuleShims.src = 'https:\/\/ga.jspm.io\/npm:es-module-shims@1.10.1\/dist\/es-module-shims.js';\n    document.head.appendChild(esModuleShims);\n\n    \/\/ Load the import map\n    var importMap = document.createElement('script');\n    importMap.type = 'importmap';\n    importMap.text = JSON.stringify({\n        imports: {\n            \"@m2c2kit\/core\": \"https:\/\/cdn.jsdelivr.net\/npm\/@m2c2kit\/core@0.3.26\/dist\/index.min.js\",\n            \"@m2c2kit\/session\": \"https:\/\/cdn.jsdelivr.net\/npm\/@m2c2kit\/session@0.3.8\/dist\/index.min.js\",\n            \"@m2c2kit\/addons\": \"https:\/\/cdn.jsdelivr.net\/npm\/@m2c2kit\/addons@0.3.25\/dist\/index.min.js\",\n            \"@m2c2kit\/physics\": \"https:\/\/cdn.jsdelivr.net\/npm\/@m2c2kit\/physics@0.1.13\/dist\/index.min.js\",\n            \"@m2c2kit\/assessment-color-dots\": \"https:\/\/cdn.jsdelivr.net\/npm\/@m2c2kit\/assessment-color-dots@0.8.24\/dist\/index.min.js\",\n            \"@m2c2kit\/assessment-color-shapes\": \"https:\/\/cdn.jsdelivr.net\/npm\/@m2c2kit\/assessment-color-shapes@0.8.24\/dist\/index.min.js\",\n            \"@m2c2kit\/assessment-grid-memory\": \"https:\/\/cdn.jsdelivr.net\/npm\/@m2c2kit\/assessment-grid-memory@0.8.24\/dist\/index.min.js\",\n            \"@m2c2kit\/assessment-symbol-search\": \"https:\/\/cdn.jsdelivr.net\/npm\/@m2c2kit\/assessment-symbol-search@0.8.24\/dist\/index.min.js\"\n        }\n    });\n    document.head.appendChild(importMap);\n\n    \/\/ Load your main JavaScript module after the page is fully loaded\n    var script = document.createElement('script');\n    script.type = 'module';\n    script.text = `\n        import { ActivityType } from \"@m2c2kit\/core\";\n        import { Session } from \"@m2c2kit\/session\";\n        import { ColorDots } from \"@m2c2kit\/assessment-color-dots\";\n        import { ColorShapes } from \"@m2c2kit\/assessment-color-shapes\";\n        import { GridMemory } from \"@m2c2kit\/assessment-grid-memory\";\n        import { SymbolSearch } from \"@m2c2kit\/assessment-symbol-search\";\n\t\t\n        const m2c2Order = '` + Qualtrics.SurveyEngine.getEmbeddedData(\"M2C2_ASSESSMENT_ORDER\") + `';\n        const m2c2Language = '` + Qualtrics.SurveyEngine.getEmbeddedData(\"M2C2_LANGUAGE\") + `';\n        const m2c2AutoAdvance = '` + Qualtrics.SurveyEngine.getEmbeddedData(\"M2C2_AUTO_ADVANCE\") + `' === \"TRUE\";\n\t\tconst m2c2Debug = '` + Qualtrics.SurveyEngine.getEmbeddedData(\"M2C2_DEBUG\") + `' === \"TRUE\";\n\t\t\n\t\tif (m2c2Debug) {\n\t\t\tconsole.log(\"M2C2 Order: \" + m2c2Order);\n\t\t\tconsole.log(\"M2C2 Language: \" + m2c2Language);\n\t\t\tconsole.log(\"M2C2 Auto Advance: \" + m2c2AutoAdvance);\n\t\t\tconsole.log(\"M2C2 Debug: \" + m2c2Debug);\t\t\t\n\t\t}\n\t\t\n\t\t\/\/ Get order of assessments and handle each dynamically\n        const m2c2OrderArray = m2c2Order.split(',');\n\t\t\n\t\t\/\/ Check that order is valid\n        if ((m2c2OrderArray.length !== 4) || (m2c2OrderArray.length !== new Set(m2c2OrderArray).size)) {\n            console.error('Invalid order string.');\n            alert('Invalid order string.');\n\t\t}\n\t\t\n        const activities = [];\n\n        function buildParams(assessmentIndex, numTrials, language, addParamsString) {\n            var params = { number_of_trials: numTrials, locale: language };\n\t\t\tif (m2c2Debug) {\n            \tconsole.log(\"Additional params: \" + addParamsString);\n\t\t\t}\n            addParamsString = addParamsString.trim();\n            if (addParamsString !== \"\") {\n                var additionalParams = addParamsString.split(',').filter(line => line.trim() !== '');\n                additionalParams.forEach(paramLine => {\n\t\t\t\t\tconst parts = paramLine.split('=').map(part => part.trim());\n\t\t\t\t\tif (parts.length === 2) {\n\t\t\t\t\t\tconst [key, value] = parts;\n\t\t\t\t\t\tparams[key] = value;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.error('Invalid parameter format:', paramLine);\n\t\t\t\t\t}\n                });\n            }\n            return params;\n        }\n\t\t\n\t\t\/\/ Loop through the order and dynamically build activities based on the order\n        for (let i = 0; i < m2c2OrderArray.length; i++) {\n            const assessment = m2c2OrderArray[i];\n            const assessmentIndex = \"M2C2_ASSESSMENT_\" + String(i).padStart(2, '0');\n            const numTrials = parseInt(Qualtrics.SurveyEngine.getEmbeddedData(assessmentIndex + \"_NUM_TRIALS\")) || 0;\n            const addParams = Qualtrics.SurveyEngine.getEmbeddedData(assessmentIndex + \"_ADD_PARAMS\") || \"\";\n\n            if (assessment === 'SYMBOL_SEARCH' && numTrials > 0) {\n                const symbolSearch = new SymbolSearch();\n                symbolSearch.setParameters(buildParams(i, numTrials, m2c2Language, addParams));\n                activities.push(symbolSearch);\n\t\t\t\tif (m2c2Debug) {\n\t\t\t\t\tconsole.log(\"Added M2C2 Symbol Search Assessment with \" + numTrials + \" trials using additional parameters ('\" + addParams + \"')\");\n\t\t\t\t}\n            } else if (assessment === 'COLOR_DOTS' && numTrials > 0) {\n                const colorDots = new ColorDots();\n                colorDots.setParameters(buildParams(i, numTrials, m2c2Language, addParams));\n                activities.push(colorDots);\n\t\t\t\tif (m2c2Debug) {\n\t\t\t\t\tconsole.log(\"Added M2C2 Color Dots Assessment with \" + numTrials + \" trials using additional parameters ('\" + addParams + \"')\");\n\t\t\t\t}\n            } else if (assessment === 'COLOR_SHAPES' && numTrials > 0) {\n                const colorShapes = new ColorShapes();\n                colorShapes.setParameters(buildParams(i, numTrials, m2c2Language, addParams));\n                activities.push(colorShapes);\n\t\t\t\tif (m2c2Debug) {\n\t\t\t\t\tconsole.log(\"Added M2C2 Color Shapes Assessment with \" + numTrials + \" trials using additional parameters ('\" + addParams + \"')\");\n\t\t\t\t}\n            } else if (assessment === 'GRID_MEMORY' && numTrials > 0) {\n                const gridMemory = new GridMemory();\n                gridMemory.setParameters(buildParams(i, numTrials, m2c2Language, addParams));\n                activities.push(gridMemory);\n\t\t\t\tif (m2c2Debug) {\n\t\t\t\t\tconsole.log(\"Added M2C2 Grid Memory Assessment with \" + numTrials + \" trials using additional parameters ('\" + addParams + \"')\");\n\t\t\t\t}\n            }\n        }\n\n        const session = new Session({ activities: activities });\n\n        session.onActivityData((ev) => {\n\n            var lastTrial = ev.data.trials[ev.data.trials.length - 1];\n\t\t\t\n            var trialIndex = String(lastTrial.trial_index).padStart(2, '0');\n\t\t\t\n\t\t\tvar assessmentIndex = String(session.options.activities.indexOf(session.currentActivity)).padStart(2, '0');\n\t\t\t\n\t\t\tif (m2c2Debug) {\n            \tconsole.log('Activity Data:', ev);\n\t\t\t\tconsole.log(\"Last trial: \", lastTrial);\n\t\t\t\tconsole.log(\"Trial index: \", trialIndex);\n\t\t\t\tconsole.log(\"Activity index: \", assessmentIndex);\n\t\t\t}\n\t\t\t\n\t\t\tQualtrics.SurveyEngine.setEmbeddedData(\"M2C2_ASSESSMENT_\" + assessmentIndex + \"_TRIAL_DATA_\" + trialIndex, JSON.stringify(lastTrial));\n        });\n\n        session.onEnd((ev) => {\n\t\t\tif (m2c2Debug) {\n            \tconsole.log(\"Ending M2C2Kit:\", ev);\n\t\t\t}\n\n            if (m2c2AutoAdvance) {\n                jQuery(\".NextButton\").click();\n                jQuery(\"#Questions\").hide();\n                jQuery(\"#Buttons\").hide();\n            }\n\n            jQuery(\"#m2c2kit-container\").hide();\n        });\n\n        window.m2c2kitSession = session;\n        session.initialize();\n    `;\n    document.body.appendChild(script);\n});"
                        }
                    }
                ]
            };

            // Function to update EmbeddedData for a given flow ID based on the number of trials
            function updateFlow(flowID, trialCount, descriptionPrefix) {
                // Remove existing trial data for this flow
                qsf.SurveyElements[1].Payload.Flow = qsf.SurveyElements[1].Payload.Flow.filter(flow => {
                    return !(flow.FlowID === flowID && flow.Type === "EmbeddedData" && flow.EmbeddedData.length > 0 && flow.EmbeddedData[0].Description.startsWith(descriptionPrefix));
                });

                if (trialCount === 0 || trialCount === "0") {
                    console.log("No trials for", flowID);
                    return;
                }

                // Find or create the flow for adding trial data
                let flow = qsf.SurveyElements[1].Payload.Flow.find(flow => flow.FlowID === flowID);
                if (!flow) {
                    flow = {
                        "Type": "EmbeddedData",
                        "FlowID": flowID,
                        "EmbeddedData": []
                    };
                    qsf.SurveyElements[1].Payload.Flow.push(flow);
                    //console.log("Adding new flow for", flowID);
                }

                // Loop to add trial data entries based on the number of trials
                for (let i = 0; i < trialCount; i++) {
                    const trialData = {
                        "Description": `${descriptionPrefix}_0${i}`,
                        "Type": "Recipient",
                        "Field": `${descriptionPrefix}_0${i}`,
                        "VariableType": "String",
                        "DataVisibility": [],
                        "AnalyzeText": false
                    };

                    flow.EmbeddedData.push(trialData);
                }
            }

            // modify fields: SYMBOL_SEARCH_NUM_TRIALS, COLOR_SHAPES_NUM_TRIALS, COLOR_DOTS_NUM_TRIALS, GRID_MEMORY_NUM_TRIALS with the values from the form

            var taskOrderString = "";
            for (let i = 0; i < 4; i++) {
                let numTrials = parseInt(sessionActivities[i].trials);
                let addParams = sessionActivities[i].params;

                qsf.SurveyElements[1].Payload.Flow[0].EmbeddedData[i].Value = numTrials;
                qsf.SurveyElements[1].Payload.Flow[0].EmbeddedData[i+7].Value = addParams;

                if (i < 3) {
                    taskOrderString += sessionActivities[i].task + ",";
                } else {
                    taskOrderString += sessionActivities[i].task;
                }

                updateFlow("FL_" + (i + 5), numTrials, "M2C2_ASSESSMENT_0" + i + "_TRIAL_DATA");
            }

            qsf.SurveyElements[1].Payload.Flow[0].EmbeddedData[4].Value = language;
            qsf.SurveyElements[1].Payload.Flow[0].EmbeddedData[5].Value = taskOrderString;
            qsf.SurveyElements[1].Payload.Flow[0].EmbeddedData[6].Value = autoComplete;

            return new Blob([JSON.stringify(qsf)], { type: 'application/json' });
        }

    </script>
</body>

</html>
